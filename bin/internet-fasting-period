#!/bin/sh

PROGNAME=$(basename $0)

FILEPATH=/home/ubuntu/.internet_fasting_period
DNSMASQ_TOGGLE_DIR=/etc/dnsmasq.toggle
PRIV_FILEPATH=/home/ubuntu/.internet_fasting_priv_period
DNSMASQ_PRIV_TOGGLE_DIR=/etc/dnsmasq.priv/toggle

main() {
  subcommand=$1
  period=$2

  case $subcommand in
    get)
      get_value
      ;;
    set)
      validate_value
      set_value
      get_value
      ;;
    *)
      usage
      exit 1
      ;;
  esac
}

get_value() {
  echo    "$(basename $FILEPATH)"
  echo -n "	Counter:  "
  cat     $FILEPATH
  echo -n "	Status:   "
  if [ -n $(ls $DNSMASQ_TOGGLE_DIR) ]; then
    echo "\033[38;05;10menabled\033[m"
  else
    echo "\033[38;05;9mdisabled\033[m"
  fi

  echo

  echo    "$(basename $PRIV_FILEPATH)"
  echo -n "	Counter:  "
  cat     $PRIV_FILEPATH
  echo -n "	Status:   "
  if [ -n $(ls $DNSMASQ_PRIV_TOGGLE_DIR) ]; then
    echo "\033[38;05;10menabled\033[m"
  else
    echo "\033[38;05;9mdisabled\033[m"
  fi
}

set_value() {
  echo $period > $FILEPATH
  echo $period > $PRIV_FILEPATH

  if [ "$(diff $FILEPATH $PRIV_FILEPATH)" != "" ]; then
    echo "Error: diff between two files exists" >&2
    exit 2
  fi
}

validate_value() {
  if [ -z $period ]; then
    usage
    exit 1
  fi

  if ! $(is_integer $period && echo true || echo false); then
    echo "Error: \"$period\" is not a integer value" >&2
    exit 1
  fi
}

is_integer() {
  test 0 -eq $1 > /dev/null 2>&1 || expr $1 + 0 > /dev/null 2>&1
}

usage() {
  echo "Usage:"
  echo "	$PROGNAME get"
  echo "	$PROGNAME set <NUMBER>"
}

main "$@"
