#!/bin/bash

set -eu

PROG_NAME=$(basename "$0")
FULL_PATH=$(dirname "$(realpath "$0")")
CRON_FILENAME="cron.conf"
ROOT_CRON_FILENAME="root_cron.conf"

main() {
  if [ $# -gt 1 ]; then
    echo "$PROG_NAME: Too many arguments" >&2
    exit 1
  fi

  if [ -z "$1" ]; then
    echo "$PROG_NAME: Missing argument" >&2
    exit 1
  fi

  if ! [ -d "$FULL_PATH/../$1" ]; then
    echo "$PROG_NAME: No such directory: $FULL_PATH/../$1" >&2
    exit 1
  fi

  if [ "$(whoami)" != "root" ]; then
    filename=$CRON_FILENAME
  else
    filename=$ROOT_CRON_FILENAME
  fi

  if ! [ -e "$FULL_PATH/../$1/$filename" ]; then
    echo "$PROG_NAME: No such file: $FULL_PATH/../$1/$filename"
    exit 1
  fi

  if ! [ -e "$FULL_PATH/../$1/private/$filename" ]; then
    echo "$PROG_NAME: No such file: $FULL_PATH/../$1/private/$filename"
    exit 1
  fi

  crontab < <(print_conf "$@")

  if [ "$(diff <(print_conf "$@") <(crontab -l))" != "" ]; then
    echo "$PROG_NAME: It looks like something went wrong" >&2
    echo >&2
    echo "The diff shows here:" >&2
    diff <(print_conf "$@") <(crontab -l) >&2
    exit 2
  else
    crontab -l
  fi
}

print_conf() {
  echo "##### BEGIN PUBLIC CRON CONF #####"
  cat "$FULL_PATH/../$1/$filename"
  echo "##### END PUBLIC CRON CONF #####"
  echo
  echo
  echo
  echo "##### BEGIN PRIVATE CRON CONF #####"
  cat "$FULL_PATH/../$1/private/$filename"
  echo "##### END PRIVATE CRON CONF #####"
}

main "$@"
