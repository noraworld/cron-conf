#!/bin/sh

LOG_PATH="/home/ubuntu/.log/cron-daemonctl.log"
# how long before sshd starts
# e.g. "30 min", "1 hour"
RECOVERY_TIME="30 min"
UPTIME_THRESHOLD="5"

main() {
  if [ "$(echo "$(awk '{print $1}' /proc/uptime)" / 60 | bc)" -gt "$UPTIME_THRESHOLD" ]; then
    # for debug or logging
    echo "manual disablement detected (date: \"$(date)\", args: \"$(echo "$(basename "$0")" "$*" | sed -r 's/\s$//g')\", duration: $RECOVERY_TIME)" >> "$LOG_PATH"

    # shellcheck disable=SC2046
    echo "sudo systemctl start ssh" | at now + "$RECOVERY_TIME" &&
    sudo systemctl stop ssh &&
    # kill all users logging in with sshd
    # do not quote pgrep because the error occurs when multiple users are logging in with sshd
    kill -9 $(pgrep -f "sshd: .*@pts/|mosh-server")
  fi
}

main "$@"
