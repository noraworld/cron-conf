#!/bin/sh

PROGNAME=$(basename $0)
IS_CRON_SCRIPT=$(dirname $(realpath $0))/../../bin/lib/is-cron

unlinked=false

main() {
  visibility=$1
  target=$2

  validate
  authenticate

  if [ "$visibility" = "public" ]; then
    TOGGLE_FILEPATH=/etc/dnsmasq.toggle/$target.conf
  elif [ "$visibility" = "private" ]; then
    TOGGLE_FILEPATH=/etc/dnsmasq.priv/toggle/$target.conf
  fi

  if [ -L "$TOGGLE_FILEPATH" ]; then
    unlinked=true
    unlink $TOGGLE_FILEPATH
  else
    echo "Warning: \"$TOGGLE_FILEPATH\" does not exist" >&2
  fi

  if $unlinked; then
    systemctl restart dnsmasq
  fi
}

validate() {
  if [ -z "$visibility" ] || [ -z "$target" ]; then
    usage
    exit 1
  fi

  if [ "$visibility" != "public" ] && [ "$visibility" != "private" ]; then
    usage
    exit 1
  fi
}

authenticate() {
  if [ "$(sh -c "$IS_CRON_SCRIPT")" = false ]; then
    echo "Fatal: This operation must be executed by cron, or this script does not take enough effect" >&2
    exit 2
  fi
}

usage() {
  echo "Usage:"
  echo "	$PROGNAME public|private <TARGET>"
}

main "$@"
