#!/bin/sh

SLEEP_INTERVAL=5   # one minute
RETRY_THRESHOLD=11 # one minute

PPLOGGER_COMMAND=$(basename "$0")
PPLOGGER_GRANULARITY="yearly"

main() {
  # shellcheck disable=SC2034
  for i in $(seq 0 "$RETRY_THRESHOLD"); do
    if [ "$(timedatectl | grep -c "System clock synchronized: yes")" -eq 1 ]; then
      pplogger "$PPLOGGER_COMMAND" "$PPLOGGER_GRANULARITY" "\"system_clock_synchronized\": true"
      exit 0
    else
      # echo "$i" # debug
      sleep "$SLEEP_INTERVAL"
    fi
  done

  if [ "$(timedatectl | grep -c "System clock synchronized: yes")" -eq 1 ]; then
    pplogger "$PPLOGGER_COMMAND" "$PPLOGGER_GRANULARITY" "\"system_clock_synchronized\": true"
    exit 0
  else
    # It seems to fail to synchronize the system clock
    pplogger "$PPLOGGER_COMMAND" "$PPLOGGER_GRANULARITY" "\"system_clock_synchronized\": false"
  fi
}

main
