#!/bin/sh

set -eu

PROG_NAME=$(basename "$0")

linked=false

main() {
  visibility=$1
  target=$2

  validate

  if [ "$visibility" = "public" ]; then
    TOGGLE_DIR=/etc/dnsmasq.toggle
    ORIGINAL_TOGGLE_DIR=/home/ubuntu/workspace/dnsmasq-conf/dnsmasq/dnsmasq.toggle
  elif [ "$visibility" = "private" ]; then
    TOGGLE_DIR=/etc/dnsmasq.priv/toggle
    ORIGINAL_TOGGLE_DIR=/home/ubuntu/workspace/dnsmasq-conf/dnsmasq/dnsmasq.priv/toggle
  fi

  if ! [ -e "$TOGGLE_DIR/$target.conf" ]; then
    linked=true
    ln -s "$ORIGINAL_TOGGLE_DIR/$target.conf" "$TOGGLE_DIR"
  else
    echo "Warning: \"$TOGGLE_DIR/$target.conf\" already exists" >&2
  fi

  # Restart the Dnsmasq daemon when a symlink is created
  if $linked; then
    erd --log /home/ubuntu/.log/erd.log --from "$PROG_NAME"
  fi
}

validate() {
  if [ -z "$visibility" ] || [ -z "$target" ]; then
    usage
    exit 1
  fi

  if [ "$visibility" != "public" ] && [ "$visibility" != "private" ]; then
    usage
    exit 1
  fi
}

usage() {
  echo "Usage:"
  echo "	$PROG_NAME public|private <TARGET>"
}

main "$@"
