#!/bin/sh
# shellcheck disable=SC2004

# Print Pretty Log
#
# Usage:
#   ppl "$(basename "$0")" "monthly" "\"code\": \"CONNECTION_REFUSED\", \"error\": \"failed to connect to the Internet\""

# Disable this to avoid failing to log
# set -eu

BASE_DIR="/home/ubuntu/workspace/log/pi/log"

main() {
  command="$1"
  granularity="$2"
  log="$3"
  extra="$4"
  now=$(date +%s)

  validate_args
  create_directory
  print_log
}

print_log() {
  full_path="$full_dir/$file"

  echo "{ \"created_at\": \"$(date --date @"$now" '+%Y-%m-%d %H:%M:%S')\", $log }" >> "$full_path"
}

yield_self() {
  echo "{ \"created_at\": \"$(date --date @"$now" '+%Y-%m-%d %H:%M:%S')\", \"error\": \"$1\" }" >> "$BASE_DIR/$0.log"
  exit 1
}

create_directory() {
  year=$(date  --date @"$now" +%Y)
  month=$(date --date @"$now" +%m)
  day=$(date   --date @"$now" +%d)

  case "$granularity" in
    "yearly")
      relative_dir="$command"
      file="$year.log"
      ;;
    "monthly")
      relative_dir="$command/$year"
      file="$year-$month.log"
      ;;
    "daily")
      relative_dir="$command/$year/$month"
      file="$year-$month-$day.log"
      ;;
    *)
      # It's redundant because it's already validated, but just to be safe
      yield_self "invalid granularity: $granularity"
      ;;
  esac

  full_dir="$BASE_DIR/$relative_dir"

  if ! mkdir -p "$full_dir" 2>/dev/null; then
    yield_self "failed to create directories: $full_dir"
  fi
}

validate_args() {
  # Do not use '||' or '&&' instead of 'if' just to be safe

  if [ "$command" = "" ]; then
    yield_self "empty command"
  fi

  if [ "$granularity" = "" ]; then
    yield_self "empty granularity"
  fi

  if [ "$log" = "" ]; then
    yield_self "empty log"
  fi

  if [ "$extra" != "" ]; then
    yield_self "too many args"
  fi

  if [ "$(echo "$command" | grep -cE '(^-)|[[:cntrl:][:space:]/]' || true)" -ne 0 ]; then
    yield_self "unavailable characters for a directory are included in $command"
  fi

  if [ "$granularity" != "yearly" ] && [ "$granularity" != "monthly" ] && [ "$granularity" != "daily" ]; then
    yield_self "invalid granularity: $granularity"
  fi
}

main "$@"
