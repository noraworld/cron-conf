#!/bin/sh
# shellcheck disable=SC2004

# Print Pretty Log
#
# Usage:
#   ppl "$(basename "$0")" "monthly" "\"code\": \"CONNECTION_REFUSED\", \"error\": \"failed to connect to the Internet\""

# Disable this to avoid failing to log
# set -eu

# !IMPORTANT!
#   These constants are used within yield_self().
#   All values except for an error message within this function should be declared here
#   because how arguments work in Shell Script and global variables declared within another function are so ambiguous.
#   This function is the most important because it logs an error that might happen in this script itself,
#   so it should be implemented securely.
BASE_DIR="/home/ubuntu/workspace/log/pi/log"
SELF_LOG_PATH="$BASE_DIR/$(basename "$0").log"
NOW=$(date +%s)

main() {
  declare_variables "$@"
  validate_args
  build_path
  create_directory
  print_log
}

print_log() {
  echo "{ \"created_at\": \"$(date --date @"$NOW" '+%Y-%m-%d %H:%M:%S')\", $log }" >> "$full_path"
}

# !IMPORTANT!
#   Do not call another function in here. This function should be independent.
yield_self() {
  # It doesn't matter if '$1' is missing. Checking that it's not empty and making it complicated should be more meticulous.
  echo "{ \"created_at\": \"$(date --date @"$NOW" '+%Y-%m-%d %H:%M:%S')\", \"error\": \"$1\" }" >> "$SELF_LOG_PATH"
  exit 1
}

create_directory() {
  if ! mkdir -p "$full_dir" 2>/dev/null; then
    yield_self "failed to create directories: $full_dir"
  fi
}

build_path() {
  year=$(date  --date @"$NOW" +%Y)
  month=$(date --date @"$NOW" +%m)
  day=$(date   --date @"$NOW" +%d)

  case "$granularity" in
    "yearly")
      relative_dir="$command"
      file="$year.log"
      ;;
    "monthly")
      relative_dir="$command/$year"
      file="$year-$month.log"
      ;;
    "daily")
      relative_dir="$command/$year/$month"
      file="$year-$month-$day.log"
      ;;
    *)
      # It's redundant because it's already validated, but just to be safe
      yield_self "invalid granularity: $granularity"
      ;;
  esac

  full_dir="$BASE_DIR/$relative_dir"
  full_path="$full_dir/$file"
}

validate_args() {
  # Do not use '||' or '&&' instead of 'if' just to be safe

  if [ "$command" = "" ]; then
    yield_self "empty command"
  fi

  if [ "$granularity" = "" ]; then
    yield_self "empty granularity"
  fi

  if [ "$log" = "" ]; then
    yield_self "empty log"
  fi

  if [ "$extra" != "" ]; then
    yield_self "too many args"
  fi

  if [ "$(echo "$command" | grep -cE '(^-)|[[:cntrl:][:space:]/]' || true)" -ne 0 ]; then
    yield_self "unavailable characters for a directory are included in $command"
  fi

  if [ "$granularity" != "yearly" ] && [ "$granularity" != "monthly" ] && [ "$granularity" != "daily" ]; then
    yield_self "invalid granularity: $granularity"
  fi
}

declare_variables() {
  command="$1"
  granularity="$2"
  log="$3"
  extra="$4"
}

main "$@"
