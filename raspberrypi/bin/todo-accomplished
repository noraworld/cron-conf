#!/bin/sh

# shellcheck disable=SC2004

main() {
  parse "$@"
  eval "set -- $REST"

  [ "$REPO"     = "" ] && echo "error: --repo is missing" >&2 && exit 1
  [ "$RETRY"    = "" ] && RETRY=5
  [ "$SLEEP"    = "" ] && SLEEP=3
  [ "$STANDARD" = "" ] && STANDARD=3

  count=0
  while [ "$body" = "" ] && [ "$count" -lt "$RETRY" ]; do
    body=$(gh issue view --repo "$REPO" "$(gh issue list --repo "$REPO" --limit 1 | awk '{ print $1 }')" --json body --jq .body)
    [ "$body" != "" ] && break
    sleep "$SLEEP"
    count=$(($count + 1))
  done

  if [ "$YET" = "" ]; then
    # accomplished
    if [ "$(echo "$body" | grep -c "\[x\]")" -ge "$STANDARD" ]; then
      echo "1"
    # failed to fetch
    elif [ "$body" = "" ]; then
      echo "-1"
    # not accomplished
    else
      echo "0"
    fi
  else
    # accomplished
    if [ "$(echo "$body" | grep -c "\[ \]")" -le "$STANDARD" ]; then
      echo "1"
    # failed to fetch
    elif [ "$body" = "" ]; then
      echo "-1"
    # not accomplished
    else
      echo "0"
    fi
  fi
}

# @getoptions
parser_definition() {
  setup   REST help:usage -- "Usage: todo-accomplished [options]... [arguments]..." ''
  msg -- 'Options:'
  param   REPO        --repo     -- "a target repository name"
  param   RETRY       --retry    -- "how many times to retry"
  param   SLEEP       --sleep    -- "how many seconds to wait before retrying the next one"
  param   STANDARD    --standard -- "how many to-dos to need"
  flag    YET         --yet      -- "count how many to-dos have not been accomplished yet rather than accomplished"
  disp    :usage   -h --help     -- "show help message and exit"
  disp    VERSION     --version  -- "show current version"
}
# @end

# @gengetoptions parser -i parser_definition parse
# Generated by getoptions (BEGIN)
# URL: https://github.com/ko1nksm/getoptions (v3.3.0)
REPO=''
RETRY=''
SLEEP=''
STANDARD=''
YET=''
REST=''
parse() {
  OPTIND=$(($#+1))
  while OPTARG= && [ $# -gt 0 ]; do
    case $1 in
      --?*=*) OPTARG=$1; shift
        eval 'set -- "${OPTARG%%\=*}" "${OPTARG#*\=}"' ${1+'"$@"'}
        ;;
      --no-*|--without-*) unset OPTARG ;;
      -[h]?*) OPTARG=$1; shift
        eval 'set -- "${OPTARG%"${OPTARG#??}"}" -"${OPTARG#??}"' ${1+'"$@"'}
        OPTARG= ;;
    esac
    case $1 in
      '--repo')
        [ $# -le 1 ] && set "required" "$1" && break
        OPTARG=$2
        REPO="$OPTARG"
        shift ;;
      '--retry')
        [ $# -le 1 ] && set "required" "$1" && break
        OPTARG=$2
        RETRY="$OPTARG"
        shift ;;
      '--sleep')
        [ $# -le 1 ] && set "required" "$1" && break
        OPTARG=$2
        SLEEP="$OPTARG"
        shift ;;
      '--standard')
        [ $# -le 1 ] && set "required" "$1" && break
        OPTARG=$2
        STANDARD="$OPTARG"
        shift ;;
      '--yet')
        [ "${OPTARG:-}" ] && OPTARG=${OPTARG#*\=} && set "noarg" "$1" && break
        eval '[ ${OPTARG+x} ] &&:' && OPTARG='1' || OPTARG=''
        YET="$OPTARG"
        ;;
      '-h'|'--help')
        usage
        exit 0 ;;
      '--version')
        echo "${VERSION}"
        exit 0 ;;
      --)
        shift
        while [ $# -gt 0 ]; do
          REST="${REST} \"\${$(($OPTIND-$#))}\""
          shift
        done
        break ;;
      [-]?*) set "unknown" "$1"; break ;;
      *)
        REST="${REST} \"\${$(($OPTIND-$#))}\""
    esac
    shift
  done
  [ $# -eq 0 ] && { OPTIND=1; unset OPTARG; return 0; }
  case $1 in
    unknown) set "Unrecognized option: $2" "$@" ;;
    noarg) set "Does not allow an argument: $2" "$@" ;;
    required) set "Requires an argument: $2" "$@" ;;
    pattern:*) set "Does not match the pattern (${1#*:}): $2" "$@" ;;
    notcmd) set "Not a command: $2" "$@" ;;
    *) set "Validation error ($1): $2" "$@"
  esac
  echo "$1" >&2
  exit 1
}
usage() {
cat<<'GETOPTIONSHERE'
Usage: todo-accomplished [options]... [arguments]...

Options:
      --repo REPO             a target repository name
      --retry RETRY           how many times to retry
      --sleep SLEEP           how many seconds to wait before retrying the next one
      --standard STANDARD     how many to-dos to need
      --yet                   count how many to-dos have not been accomplished yet rather than accomplished
  -h, --help                  show help message and exit
      --version               show current version
GETOPTIONSHERE
}
# Generated by getoptions (END)
# @end

main "$@"
