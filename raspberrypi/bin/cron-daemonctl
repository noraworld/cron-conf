#!/bin/sh

main() {
  authenticate
  set_env

  case "$1" in
    "start")
      if [ "$(systemctl --user is-active "$2")" != "active" ]; then
        systemctl --user "$1" "$2"
      fi
      ;;
    "stop")
      if [ "$(systemctl --user is-active "$2")" = "active" ]; then
        systemctl --user "$1" "$2"
      fi
      ;;
    *)
      systemctl --user "$1" "$2"
      ;;
  esac
}

authenticate() {
  IS_CRON_SCRIPT=$(dirname $(realpath $0))/../../bin/lib/is-cron

  if [ "$(sh -c "$IS_CRON_SCRIPT")" = false ]; then
    echo "Fatal: This operation must be executed by cron, or this script does not take enough effect" >&2
    exit 2
  fi
}

set_env() {
  # This is necessary when manipulating systemctl with cron
  #   https://superuser.com/questions/1561076/systemctl-use-failed-to-connect-to-bus-no-such-file-or-directory-debian-9
  XDG_RUNTIME_DIR=/run/user/$(id -u)
  export XDG_RUNTIME_DIR
}

main "$@"
