#!/bin/sh

PROG_NAME="auto-unlock"
SLEEP_INTERVAL=5

main() {
  changed=false

  case "$*" in
    "all")
      targets="$(services-list service all)"
      ;;
    "general")
      targets="$(services-list service general)"
      ;;
    *)
      targets="$*"
      ;;
  esac

  for target in $targets; do
    observer=$(services-list observer "$target")
    service=$(services-list service "$target")

    if
      [ "$(systemctl --user is-active "$observer")" != "active" ] &&
      [ "$(quotarget --timeframe now --service "$service" --cache-only)" -gt 0 ] &&
      [ "$(sincere --cache-only)" -gt 0 ]
    then
      unlock_command=$(services-list unlock "$target")
      visibility=$(services-list visibility "$target")
      name=$(services-list name "$target")

      if eval "$unlock_command" "$visibility" "$name" --quiet --skip; then
        changed=true
      fi

      sleep "$SLEEP_INTERVAL"
    fi
  done

  if [ "$changed" = "true" ]; then
    /home/ubuntu/workspace/dnsmasq-conf/bin/exrd --log /home/ubuntu/workspace/log/pi/log/exrd.log --from "$PROG_NAME $*"
  fi
}

main "$@"
