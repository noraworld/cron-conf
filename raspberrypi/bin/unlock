#!/bin/sh

set -eu
trap remaining_time EXIT

reference_minute=0

main() {
  service="$1"

  case "$service" in
    "chime")
      reference_minute=10
      sudo unlink /etc/dnsmasq.toggle/chime.conf
      ;;
    "deregulated-superman")
      reference_minute=30
      sudo ln -s /home/ubuntu/workspace/dnsmasq-conf/dnsmasq/dnsmasq.priv/toggle/deregulated_superman_allow.conf /etc/dnsmasq.priv/toggle
      sudo unlink /etc/dnsmasq.priv/toggle/deregulated_superman.conf
      ;;
    "ometeotl")
      reference_minute=10
      sudo unlink /etc/dnsmasq.priv/toggle/ometeotl.conf
      ;;
    "superman")
      reference_minute=60
      sudo unlink /etc/dnsmasq.priv/toggle/superman.conf
      sudo unlink /etc/dnsmasq.priv/toggle/ometeotl
      sudo unlink /etc/dnsmasq.priv/toggle/superman_upstream.conf
      sudo ln -s /home/ubuntu/workspace/dnsmasq-conf/dnsmasq/dnsmasq.priv/toggle/adguard_upstream.conf /etc/dnsmasq.priv/toggle
      ;;
    "vod")
      reference_minute=5
      sudo unlink /etc/dnsmasq.toggle/vod.conf
      ;;
    "youtube")
      reference_minute=5
      sudo unlink /etc/dnsmasq.toggle/youtube.conf
      ;;
    "youtube-music")
      reference_minute=10
      sudo ln -s /home/ubuntu/workspace/dnsmasq-conf/dnsmasq/dnsmasq.toggle/youtube_music.conf /etc/dnsmasq.toggle
      ;;
    *)
      echo "error: no such service $service" >&2
      exit 1
      ;;
  esac

  echo "restarting dnsmasq"
  sudo systemctl restart dnsmasq

  if [ "$(sudo systemctl is-active dnsmasq)" != "active" ]; then
    echo "error: dnsmasq daemon could not restart unexpectedly" >&2
    sudo systemctl status dnsmasq >&2
    exit 1
  fi
}

remaining_time() {
  if [ "$reference_minute" -gt 0 ]; then
    remaining-time $reference_minute
  fi
}

main "$@"
